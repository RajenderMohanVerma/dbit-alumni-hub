{% extends "base.html" %}

{% block content %}
<link
    href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">

<style>
    :root {
        --primary-glass: rgba(255, 255, 255, 0.9);
        --accent-blue: #0ea5e9;
        --accent-indigo: #6366f1;
        --danger-red: #ef4444;
        --success-green: #10b981;
        --text-dark: #1e293b;
        --text-muted: #64748b;
    }

    .admin-command-center {
        min-height: 100vh;
        background: radial-gradient(circle at top right, #f8fafc 0%, #f1f5f9 100%);
        padding: 40px 20px;
        font-family: 'Plus Jakarta Sans', sans-serif;
    }

    .command-header {
        margin-bottom: 40px;
        position: relative;
    }

    .command-title {
        font-family: 'Outfit', sans-serif;
        font-weight: 800;
        font-size: 2.5rem;
        background: linear-gradient(135deg, #1e3a8a 0%, #0ea5e9 100%);
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 10px;
    }

    .command-subtitle {
        color: var(--text-muted);
        font-size: 1.1rem;
    }

    .glass-card {
        background: var(--primary-glass);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.5);
        border-radius: 24px;
        padding: 30px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.05);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        height: 100%;
    }

    .glass-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 30px 60px rgba(0, 0, 0, 0.08);
    }

    .card-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-bottom: 20px;
    }

    .icon-lock {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger-red);
    }

    .icon-stats {
        background: rgba(14, 165, 233, 0.1);
        color: var(--accent-blue);
    }

    .icon-mod {
        background: rgba(99, 102, 241, 0.1);
        color: var(--accent-indigo);
    }

    .status-monitor {
        background: #f8fafc;
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .monitor-row {
        display: flex;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid #e2e8f0;
    }

    .monitor-row:last-child {
        border-bottom: none;
    }

    .monitor-label {
        font-weight: 600;
        color: var(--text-muted);
    }

    .monitor-value {
        font-weight: 700;
        color: var(--text-dark);
    }

    .badge-premium {
        padding: 6px 16px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .badge-locked {
        background: #fee2e2;
        color: #991b1b;
    }

    .badge-unlocked {
        background: #dcfce7;
        color: #166534;
    }

    .btn-premium {
        border-radius: 12px;
        padding: 14px 24px;
        font-weight: 700;
        transition: all 0.3s;
        border: none;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    .btn-lock {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
    }

    .btn-unlock {
        background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
        color: white;
    }

    .btn-load {
        background: white;
        border: 2px solid #e2e8f0;
        color: var(--text-dark);
    }

    .btn-load:hover {
        background: #f8fafc;
        border-color: var(--accent-blue);
    }

    .btn-premium:hover:not(:disabled) {
        transform: scale(1.02);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }

    .btn-premium:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .stat-ring-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin-bottom: 25px;
    }

    .stat-ring {
        text-align: center;
        padding: 15px;
        background: #f8fafc;
        border-radius: 16px;
    }

    .stat-val {
        font-size: 1.8rem;
        font-weight: 800;
        color: var(--accent-blue);
    }

    .stat-lab {
        font-size: 0.75rem;
        color: var(--text-muted);
        text-transform: uppercase;
        margin-top: 4px;
    }

    .msg-scroll-area {
        max-height: 500px;
        overflow-y: auto;
        padding-right: 10px;
    }

    .premium-msg-card {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 16px;
        padding: 16px;
        margin-bottom: 12px;
        transition: all 0.2s;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .premium-msg-card:hover {
        border-color: var(--accent-blue);
        background: #fcfdfe;
    }

    .msg-meta {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-bottom: 4px;
    }

    .msg-sender {
        font-weight: 700;
        color: var(--text-dark);
    }

    .msg-body {
        font-size: 0.95rem;
        color: #334155;
    }

    .delete-btn-circle {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: #fee2e2;
        color: #ef4444;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        transition: all 0.2s;
    }

    .delete-btn-circle:hover {
        background: #ef4444;
        color: white;
    }

    .suspension-list {
        display: grid;
        gap: 12px;
    }

    .suspended-user-card {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 12px;
        background: #f8fafc;
        border-radius: 16px;
    }

    .s-avatar {
        width: 45px;
        height: 45px;
        border-radius: 12px;
        object-fit: cover;
    }

    .s-info {
        flex: 1;
    }

    .s-name {
        font-weight: 700;
        font-size: 0.95rem;
    }

    .s-role {
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    .btn-unsuspend {
        padding: 6px 14px;
        background: var(--success-green);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 0.8rem;
        font-weight: 600;
    }
</style>

<div class="admin-command-center">
    <div class="container-fluid">
        <div class="command-header text-center">
            <h1 class="command-title">Messaging Command Center</h1>
            <p class="command-subtitle">Global Moderation & System Sovereignty Panel</p>
        </div>

        <div class="row g-4">
            <!-- System Sovereignty (Lock Control) -->
            <div class="col-lg-4">
                <div class="glass-card">
                    <div class="card-icon icon-lock">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <h3 class="fw-bold mb-4">System Sovereignty</h3>

                    <div class="status-monitor">
                        <div class="monitor-row">
                            <span class="monitor-label">Operational Status</span>
                            <span id="lockBadge" class="badge-premium">Checking...</span>
                        </div>
                        <div class="monitor-row">
                            <span class="monitor-label">Admin Control</span>
                            <span id="lockedByValue" class="monitor-value">-</span>
                        </div>
                        <div class="monitor-row">
                            <span class="monitor-label">Last Intervention</span>
                            <span id="lockedAtValue" class="monitor-value">-</span>
                        </div>
                    </div>

                    <textarea id="lockReason" class="form-control mb-3" placeholder="Reason for system intervention..."
                        rows="2" style="border-radius: 12px; border: 2px solid #f1f5f9;"></textarea>

                    <div class="d-grid gap-2">
                        <button id="lockBtn" class="btn-premium btn-lock" onclick="lockMessaging()">
                            <i class="fas fa-lock"></i> Initiate Global Lock
                        </button>
                        <button id="unlockBtn" class="btn-premium btn-unlock" onclick="unlockMessaging()">
                            <i class="fas fa-unlock"></i> Restore System
                        </button>
                    </div>
                </div>
            </div>

            <!-- Real-time Intelligence -->
            <div class="col-lg-8">
                <div class="glass-card">
                    <div class="card-icon icon-stats">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3 class="fw-bold m-0">Real-time Intelligence</h3>
                        <button class="btn btn-sm btn-load" onclick="refreshStatistics()">
                            <i class="fas fa-sync-alt"></i> Sync Data
                        </button>
                    </div>

                    <div class="stat-ring-grid">
                        <div class="stat-ring">
                            <div class="stat-val" id="publicMsgCount">0</div>
                            <div class="stat-lab">Public Broadcasts</div>
                        </div>
                        <div class="stat-ring">
                            <div class="stat-val" id="privateMsgCount">0</div>
                            <div class="stat-lab">Direct Comm Links</div>
                        </div>
                        <div class="stat-ring">
                            <div class="stat-val" id="conversationCount">0</div>
                            <div class="stat-lab">Active Channels</div>
                        </div>
                    </div>

                    <h5 class="fw-bold mb-3"><i class="fas fa-user-slash me-2 text-danger"></i> Sanctioned Entities</h5>
                    <div id="suspendedUsersList" class="suspension-list">
                        <div class="text-center py-4 text-muted">Scanning for sanctioned entities...</div>
                    </div>
                </div>
            </div>

            <!-- Content Moderation Hub -->
            <div class="col-12">
                <div class="glass-card">
                    <div class="card-icon icon-mod">
                        <i class="fas fa-users-cog"></i>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
                        <h3 class="fw-bold m-0">Broadcast Moderation Hub</h3>
                        <div class="d-flex gap-2">
                            <button id="toggleHiddenBtn" class="btn-premium btn-load py-2 px-3"
                                onclick="toggleViewHidden()">
                                <i class="fas fa-eye-slash"></i> Audit Hidden
                            </button>
                            <button class="btn-premium btn-unlock py-2 px-3" onclick="loadPublicMessages()">
                                <i class="fas fa-download"></i> Fetch Feed
                            </button>
                        </div>
                    </div>

                    <div id="messagesList" class="msg-scroll-area">
                        <div class="text-center py-5">
                            <i class="fas fa-satellite fa-3x mb-3 text-light-emphasis"></i>
                            <p class="text-muted">Enter the broadcast feed for auditing</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let isLocked = false;
    let viewingHidden = false;

    document.addEventListener('DOMContentLoaded', () => {
        refreshLockStatus();
        refreshStatistics();
        loadPublicMessages();
        loadSuspendedUsers();

        // Auto-refresh every 15s
        setInterval(() => {
            refreshStatistics();
            refreshLockStatus();
        }, 15000);
    });

    function showSuccess(msg) {
        // Simple elegant toast logic could go here, for now using console/alert for debug
        console.log('Success:', msg);
    }

    function refreshLockStatus() {
        fetch('/api/admin/messaging/status')
            .then(r => r.json())
            .then(data => {
                isLocked = data.is_locked;
                const badge = document.getElementById('lockBadge');
                const lockBtn = document.getElementById('lockBtn');
                const unlockBtn = document.getElementById('unlockBtn');
                const byVal = document.getElementById('lockedByValue');
                const atVal = document.getElementById('lockedAtValue');

                if (isLocked) {
                    badge.className = 'badge-premium badge-locked';
                    badge.textContent = 'SYSTEM LOCKED';
                    lockBtn.disabled = true;
                    unlockBtn.disabled = false;
                    byVal.textContent = data.locked_by || 'ADMIN-01';
                    atVal.textContent = data.locked_at ? new Date(data.locked_at).toLocaleTimeString() : 'N/A';
                } else {
                    badge.className = 'badge-premium badge-unlocked';
                    badge.textContent = 'OPERATIONAL';
                    lockBtn.disabled = false;
                    unlockBtn.disabled = true;
                    byVal.textContent = '-';
                    atVal.textContent = 'N/A';
                }
            });
    }

    function lockMessaging() {
        const reason = document.getElementById('lockReason').value;
        fetch('/api/admin/messaging/lock', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reason })
        })
            .then(r => r.json())
            .then(() => {
                refreshLockStatus();
                document.getElementById('lockReason').value = '';
            });
    }

    function unlockMessaging() {
        fetch('/api/admin/messaging/unlock', { method: 'POST' })
            .then(() => refreshLockStatus());
    }

    function refreshStatistics() {
        fetch('/api/admin/messaging/statistics')
            .then(r => r.json())
            .then(data => {
                document.getElementById('publicMsgCount').textContent = data.statistics.total_public_messages;
                document.getElementById('privateMsgCount').textContent = data.statistics.total_private_messages;
                document.getElementById('conversationCount').textContent = data.statistics.total_conversations;
            });
    }

    function loadPublicMessages() {
        const includeHidden = viewingHidden ? 'true' : 'false';
        fetch(`/api/admin/messaging/public-messages?include_hidden=${includeHidden}&limit=100`)
            .then(r => r.json())
            .then(data => {
                const list = document.getElementById('messagesList');
                if (!data.messages || data.messages.length === 0) {
                    list.innerHTML = '<div class="text-center py-5 text-muted">Feed is currently empty.</div>';
                    return;
                }

                list.innerHTML = '';
                data.messages.forEach(msg => {
                    const card = document.createElement('div');
                    card.className = 'premium-msg-card';
                    card.innerHTML = `
                        <div class="msg-content">
                            <div class="msg-meta">
                                <span class="msg-sender">${msg.name}</span> â€¢ 
                                <span>${new Date(msg.created_at).toLocaleString()}</span>
                                ${msg.is_hidden ? '<span class="ms-2 text-danger fw-bold">(HIDDEN)</span>' : ''}
                            </div>
                            <div class="msg-body">${escapeHtml(msg.content)}</div>
                        </div>
                        <button class="delete-btn-circle" onclick="deleteMessage(${msg.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    list.appendChild(card);
                });
            });
    }

    function toggleViewHidden() {
        viewingHidden = !viewingHidden;
        const btn = document.getElementById('toggleHiddenBtn');
        btn.innerHTML = viewingHidden ? '<i class="fas fa-eye"></i> Show Active' : '<i class="fas fa-eye-slash"></i> Audit Hidden';
        loadPublicMessages();
    }

    function deleteMessage(id) {
        if (confirm('Permanently redact this broadcast?')) {
            fetch(`/api/messages/public/${id}`, { method: 'DELETE' })
                .then(() => loadPublicMessages());
        }
    }

    function loadSuspendedUsers() {
        fetch('/api/admin/messaging/suspended-users')
            .then(r => r.json())
            .then(data => {
                const list = document.getElementById('suspendedUsersList');
                if (!data.users || data.users.length === 0) {
                    list.innerHTML = '<div class="text-center py-4 text-muted">No sanctioned entities detected.</div>';
                    return;
                }

                list.innerHTML = '';
                data.users.forEach(u => {
                    const avatar = u.profile_pic ? u.profile_pic : 'https://ui-avatars.com/api/?name=' + encodeURIComponent(u.name) + '&background=random';
                    const card = document.createElement('div');
                    card.className = 'suspended-user-card';
                    card.innerHTML = `
                        <img src="${avatar}" class="s-avatar">
                        <div class="s-info">
                            <div class="s-name">${u.name}</div>
                            <div class="s-role">${u.role.toUpperCase()}</div>
                        </div>
                        <button class="btn-unsuspend" onclick="unsuspendUser(${u.id})">Restore Privileges</button>
                    `;
                    list.appendChild(card);
                });
            });
    }

    function unsuspendUser(id) {
        fetch('/api/admin/messaging/unsuspend', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: id })
        })
            .then(() => loadSuspendedUsers());
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
{% endblock %}