{% extends 'base.html' %}
{% block content %}
<style>
    :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
        --warning-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        --danger-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        --info-gradient: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        --glass-bg: rgba(255, 255, 255, 0.9);
        --glass-border: rgba(255, 255, 255, 0.2);
        --card-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
    }

    .admin-container {
        max-width: 1440px;
        margin: 0 auto;
        padding: 2rem 1.5rem;
    }

    /* Page Header */
    .page-header {
        background: var(--primary-gradient);
        padding: 3rem 2.5rem;
        border-radius: 24px;
        margin-bottom: 2.5rem;
        box-shadow: 0 15px 35px rgba(102, 126, 234, 0.25);
        color: white;
        position: relative;
        overflow: hidden;
    }

    .page-header::after {
        content: '';
        position: absolute;
        top: -50%;
        right: -10%;
        width: 400px;
        height: 400px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        pointer-events: none;
    }

    .page-header h1 {
        font-size: 2.8rem;
        font-weight: 800;
        margin: 0;
        letter-spacing: -0.5px;
    }

    .page-header p {
        opacity: 0.9;
        font-size: 1.2rem;
        margin-top: 0.5rem;
        font-weight: 400;
    }

    /* Stat Cards */
    .stat-card {
        background: white;
        border-radius: 20px;
        padding: 1.75rem;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        box-shadow: var-card-shadow;
        border: 1px solid #f1f5f9;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
    }

    .stat-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    }

    .stat-card.students {
        border-left: 6px solid #3b82f6;
    }

    .stat-card.alumni {
        border-left: 6px solid #f59e0b;
    }

    .stat-card.faculty {
        border-left: 6px solid #10b981;
    }

    .stat-card.funds {
        border-left: 6px solid #8b5cf6;
    }

    .stat-icon {
        font-size: 2.2rem;
        margin-bottom: 1rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 60px;
        height: 60px;
        border-radius: 16px;
        background: #f8fafc;
    }

    .stat-number {
        font-size: 2.4rem;
        font-weight: 800;
        color: #1e293b;
        margin: 0.5rem 0;
    }

    .stat-label {
        font-size: 1rem;
        color: #64748b;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Chart Containers */
    .chart-container {
        background: white;
        border-radius: 24px;
        padding: 2rem;
        box-shadow: var-card-shadow;
        margin-bottom: 2rem;
        border: 1px solid #f1f5f9;
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .chart-title {
        font-size: 1.4rem;
        font-weight: 700;
        color: #1e293b;
    }

    /* Section Cards */
    .section-card {
        background: white;
        border-radius: 24px;
        padding: 2.5rem;
        box-shadow: var-card-shadow;
        margin-bottom: 2.5rem;
        border: 1px solid #f1f5f9;
    }

    .section-title {
        font-size: 1.6rem;
        font-weight: 750;
        color: #1e293b;
        margin-bottom: 2rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .section-title i {
        color: #6366f1;
    }

    /* Download Grid */
    .download-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
    }

    .download-card {
        background: #f8fafc;
        border-radius: 20px;
        padding: 2rem;
        text-align: center;
        border: 2px solid transparent;
        transition: all 0.3s ease;
    }

    .download-card:hover {
        background: white;
        border-color: #6366f1;
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(99, 102, 241, 0.1);
    }

    .download-card h3 {
        font-size: 1.25rem;
        font-weight: 700;
        margin: 1rem 0 0.5rem;
        color: #1e293b;
    }

    .download-btn {
        background: var(--primary-gradient);
        color: white;
        border: none;
        padding: 0.8rem 1.5rem;
        border-radius: 12px;
        font-weight: 600;
        width: 100%;
        margin-top: 1.5rem;
        transition: all 0.3s ease;
    }

    .download-btn:hover:not(:disabled) {
        transform: scale(1.02);
        filter: brightness(1.1);
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
    }

    /* Table Enhancements */
    .table-responsive-container {
        border-radius: 20px;
        overflow: hidden;
        border: 1px solid #e2e8f0;
    }

    .table {
        margin-bottom: 0;
    }

    .table thead th {
        background: #f8fafc;
        color: #64748b;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid #e2e8f0;
    }

    .table tbody td {
        padding: 1.25rem 1.5rem;
        vertical-align: middle;
        color: #334155;
        border-bottom: 1px solid #f1f5f9;
    }

    /* Search Bar */
    .table-search-wrapper {
        position: relative;
        max-width: 400px;
        margin-bottom: 1.5rem;
    }

    .table-search-input {
        width: 100%;
        padding: 0.8rem 1rem 0.8rem 3rem;
        border-radius: 12px;
        border: 2px solid #e2e8f0;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .table-search-input:focus {
        border-color: #6366f1;
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        outline: none;
    }

    .table-search-icon {
        position: absolute;
        left: 1.2rem;
        top: 50%;
        transform: translateY(-50%);
        color: #94a3b8;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    ::-webkit-scrollbar-track {
        background: #f8fafc;
    }

    ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }

    /* Badges */
    .badge-modern {
        padding: 0.6rem 1rem;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.8rem;
    }

    .badge-student {
        background: #dbeafe;
        color: #1e40af;
    }

    .badge-alumni {
        background: #fef3c7;
        color: #92400e;
    }

    .badge-faculty {
        background: #dcfce7;
        color: #166534;
    }

    /* Action Buttons */
    .action-btn {
        padding: 0.5rem 1rem;
        border-radius: 10px;
        font-weight: 600;
        font-size: 0.85rem;
        transition: all 0.2s ease;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .delete-btn {
        background: #fee2e2;
        color: #ef4444;
    }

    .delete-btn:hover {
        background: #ef4444;
        color: white;
    }

    /* Responsive adjustments */
    @media (max-width: 991px) {
        .page-header {
            padding: 2rem;
        }

        .page-header h1 {
            font-size: 2.2rem;
        }

        .section-card {
            padding: 1.5rem;
        }
    }

    @media (max-width: 768px) {
        .stat-number {
            font-size: 2rem;
        }

        .download-grid {
            grid-template-columns: 1fr;
        }

        .table-search-wrapper {
            max-width: 100%;
        }

        /* Table mobile optimization */
        .table condensation {
            display: block;
        }
    }
</style>

<div class="admin-container">
    <!-- Page Header -->
    <div class="page-header animate__animated animate__fadeInDown">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1>ðŸ‘‹ Hello, Admin!</h1>
                <p>Welcome to your central control hub. Monitor growth and manage the community.</p>
            </div>
            <div class="col-md-4 text-md-end d-none d-md-block">
                <div class="header-clock" id="digitalClock" style="font-size: 1.5rem; font-weight: 700; opacity: 0.9;">
                </div>
                <p class="mb-0" id="currentDate" style="opacity: 0.8; font-size: 0.9rem;"></p>
            </div>
        </div>
    </div>

    <!-- Stats Cards Row -->
    <div class="row g-4 mb-5">
        <div class="col-xl-3 col-md-6 animate__animated animate__fadeInUp" style="animation-delay: 0.1s;">
            <div class="stat-card students">
                <div>
                    <div class="stat-icon"><i class="fas fa-user-graduate text-primary"></i></div>
                    <div class="stat-label">Students</div>
                    <div class="stat-number">{{ s_count }}</div>
                </div>
                <div class="progress mt-3" style="height: 6px;">
                    <div class="progress-bar bg-primary" style="width: 75%"></div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 animate__animated animate__fadeInUp" style="animation-delay: 0.2s;">
            <div class="stat-card alumni">
                <div>
                    <div class="stat-icon"><i class="fas fa-user-tie text-warning"></i></div>
                    <div class="stat-label">Alumni</div>
                    <div class="stat-number">{{ a_count }}</div>
                </div>
                <div class="progress mt-3" style="height: 6px;">
                    <div class="progress-bar bg-warning" style="width: 60%"></div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 animate__animated animate__fadeInUp" style="animation-delay: 0.3s;">
            <div class="stat-card faculty">
                <div>
                    <div class="stat-icon"><i class="fas fa-chalkboard-teacher text-success"></i></div>
                    <div class="stat-label">Faculty</div>
                    <div class="stat-number">{{ f_count }}</div>
                </div>
                <div class="progress mt-3" style="height: 6px;">
                    <div class="progress-bar bg-success" style="width: 45%"></div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 animate__animated animate__fadeInUp" style="animation-delay: 0.4s;">
            <div class="stat-card funds">
                <div>
                    <div class="stat-icon"><i class="fas fa-calendar-check text-purple"></i></div>
                    <div class="stat-label">Event Registrations</div>
                    <div class="stat-number">{{ event_total }}</div>
                </div>
                <div class="progress mt-3" style="height: 6px;">
                    <div class="progress-bar bg-purple" style="width: 85%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row g-4 mb-5">
        <div class="col-lg-8 animate__animated animate__fadeInLeft">
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">Growth Analytics</div>
                </div>
                <canvas id="growthChart" height="150"></canvas>
            </div>
        </div>
        <div class="col-lg-4 animate__animated animate__fadeInRight">
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">User Mix</div>
                </div>
                <canvas id="userChart" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- Registrations Section -->
    <div class="section-card animate__animated animate__fadeIn">
        <div class="section-title">
            <i class="fas fa-id-card"></i> Recent Registrations
        </div>

        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
            <div class="table-search-wrapper">
                <i class="fas fa-search table-search-icon"></i>
                <input type="text" id="userSearch" class="table-search-input"
                    placeholder="Search by name, email, or role...">
            </div>
            <div class="d-flex gap-2">
                <select id="roleFilter" class="form-select form-select-sm" style="border-radius: 10px; width: auto;">
                    <option value="all">All Roles</option>
                    <option value="student">Students</option>
                    <option value="alumni">Alumni</option>
                    <option value="faculty">Faculty</option>
                </select>
            </div>
        </div>

        <div class="table-responsive-container">
            <table class="table table-hover" id="usersTable">
                <thead>
                    <tr>
                        <th>Member Details</th>
                        <th>Position/Role</th>
                        <th>Department</th>
                        <th>Verified Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users[:15] %}
                    <tr class="user-row" data-role="{{ user['role'] }}">
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm me-3"
                                    style="width: 45px; height: 45px; border-radius: 12px; overflow: hidden;">
                                    <img src="https://ui-avatars.com/api/?name={{ user['name'] }}&background=667eea&color=fff"
                                        alt="" class="img-fluid">
                                </div>
                                <div>
                                    <h6 class="mb-0 fw-bold">{{ user['name'] }}</h6>
                                    <small class="text-muted">{{ user['email'] }}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            {% if user['role'] == 'student' %}
                            <span class="badge-modern badge-student">Student</span>
                            {% elif user['role'] == 'alumni' %}
                            <span class="badge-modern badge-alumni">Alumni</span>
                            {% else %}
                            <span class="badge-modern badge-faculty">Faculty</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="text-dark">{{ user['department'] or 'General' }}</div>
                            <small class="text-muted">Batch: 2024</small>
                        </td>
                        <td>
                            <span class="text-success"><i class="fas fa-check-circle me-1"></i> Verified</span>
                        </td>
                        <td>
                            <div class="d-flex gap-2">
                                {% if user['email'] == 'admin@college.edu' %}
                                <span class="badge bg-warning text-dark px-3 py-2" style="border-radius: 10px;">
                                    <i class="fas fa-shield-alt me-1"></i> Protected Account
                                </span>
                                {% else %}
                                <button class="action-btn delete-btn"
                                    onclick="confirmDelete({{ user['id'] }}, '{{ user['name'] }}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Downloads Section -->
    <div class="section-card">
        <div class="section-title">
            <i class="fas fa-file-export"></i> Data Exports
        </div>

        <ul class="nav nav-pills mb-4" id="exportTabs" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#csvExports">CSV Reports</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="pill" data-bs-target="#dbExports">Database Backups</button>
            </li>
        </ul>

        <div class="tab-content" id="exportTabsContent">
            <!-- CSV Exports -->
            <div class="tab-pane fade show active" id="csvExports">
                <div class="download-grid">
                    <div class="download-card">
                        <div class="stat-icon"><i class="fas fa-user-graduate text-primary"></i></div>
                        <h3>Student Records</h3>
                        <p class="text-muted">Complete profiles with academic data</p>
                        <button class="download-btn" onclick="downloadData('student', 'csv')">Export CSV</button>
                    </div>
                    <div class="download-card">
                        <div class="stat-icon"><i class="fas fa-user-tie text-warning"></i></div>
                        <h3>Alumni Directory</h3>
                        <p class="text-muted">Professional details and contact info</p>
                        <button class="download-btn" onclick="downloadData('alumni', 'csv')">Export CSV</button>
                    </div>
                    <div class="download-card">
                        <div class="stat-icon"><i class="fas fa-users text-success"></i></div>
                        <h3>Master List</h3>
                        <p class="text-muted">Full registered user database</p>
                        <button class="download-btn" onclick="downloadData('all', 'csv')">Export CSV</button>
                    </div>
                </div>
            </div>

            <!-- DB Exports -->
            <div class="tab-pane fade" id="dbExports">
                <div class="download-grid">
                    <div class="download-card">
                        <div class="stat-icon"><i class="fas fa-database text-info"></i></div>
                        <h3>System Core DB</h3>
                        <p class="text-muted">Standard college_pro.db snapshot</p>
                        <button class="download-btn" onclick="downloadData('college_pro', 'db')">Download .db</button>
                    </div>
                    <div class="download-card">
                        <div class="stat-icon"><i class="fas fa-server text-secondary"></i></div>
                        <h3>Alumni Snapshot</h3>
                        <p class="text-muted">Alumni-specific database file</p>
                        <button class="download-btn" onclick="downloadData('alumni', 'db')">Download .db</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Custom Confirmation Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0" style="border-radius: 20px;">
            <div class="modal-body p-4 text-center">
                <div class="mb-4">
                    <i class="fas fa-exclamation-triangle text-danger" style="font-size: 4rem;"></i>
                </div>
                <h3 class="fw-bold mb-2">Are you sure?</h3>
                <p class="text-muted mb-4">You are about to delete <span id="deleteUserName"
                        class="fw-bold text-dark"></span>. This action cannot be undone.</p>
                <div class="d-grid gap-2">
                    <button class="btn btn-danger btn-lg py-3" style="border-radius: 12px;" id="finalDeleteBtn">Yes,
                        Delete User</button>
                    <button class="btn btn-light btn-lg py-3" style="border-radius: 12px;"
                        data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Delete Logic - Must be in global scope for inline onclick handlers
    let userIdToDelete = null;
    let deleteModal = null;

    function confirmDelete(id, name) {
        userIdToDelete = id;
        document.getElementById('deleteUserName').textContent = name;
        if (!deleteModal) {
            deleteModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
        }
        deleteModal.show();
    }

    // Initialize Charts and other functionality
    document.addEventListener('DOMContentLoaded', function () {
        // Growth Chart
        const ctxGrowth = document.getElementById('growthChart').getContext('2d');
        new Chart(ctxGrowth, {
            type: 'line',
            data: {
                labels: {{ chart_data.years | tojson }},
        datasets: [{
            label: 'Placements',
            data: {{ chart_data.placements | tojson }},
        borderColor: '#6366f1',
        backgroundColor: 'rgba(99, 102, 241, 0.1)',
        fill: true,
        tension: 0.4,
        borderWidth: 3
                }, {
            label: 'Events',
            data: {{ chart_data.events | tojson }},
        borderColor: '#f59e0b',
        backgroundColor: 'rgba(245, 158, 11, 0.1)',
        fill: true,
        tension: 0.4,
        borderWidth: 3
                }]
            },
        options: {
        responsive: true,
        plugins: { legend: { position: 'top' } },
        scales: {
            y: { beginAtZero: true, grid: { borderDash: [5, 5] } },
            x: { grid: { display: false } }
        }
    }
        });

    // User Mix Chart
    const ctxUser = document.getElementById('userChart').getContext('2d');
    new Chart(ctxUser, {
        type: 'doughnut',
        data: {
            labels: ['Students', 'Alumni', 'Faculty'],
            datasets: [{
                data: [{{ s_count }}, {{ a_count }}, {{ f_count }}],
        backgroundColor: ['#6366f1', '#f59e0b', '#10b981'],
        hoverOffset: 12,
        borderWidth: 0
            }]
        },
        options: {
        cutout: '70%',
        plugins: { legend: { position: 'bottom' } }
    }
    });

    // Clock Functionality
    const updateClock = () => {
        const now = new Date();
        document.getElementById('digitalClock').textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        document.getElementById('currentDate').textContent = now.toLocaleDateString([], { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
    };
    setInterval(updateClock, 1000);
    updateClock();

    // Search & Filter Logic
    const searchInput = document.getElementById('userSearch');
    const roleFilter = document.getElementById('roleFilter');
    const userRows = document.querySelectorAll('.user-row');

    const filterTable = () => {
        const searchTerm = searchInput.value.toLowerCase();
        const selectedRole = roleFilter.value;

        userRows.forEach(row => {
            const text = row.textContent.toLowerCase();
            const role = row.dataset.role;
            const matchesSearch = text.includes(searchTerm);
            const matchesRole = selectedRole === 'all' || role === selectedRole;

            row.style.display = (matchesSearch && matchesRole) ? '' : 'none';
        });
    };

    searchInput.addEventListener('input', filterTable);
    roleFilter.addEventListener('change', filterTable);

    // Delete button handler - attach after DOM is loaded
    document.getElementById('finalDeleteBtn').addEventListener('click', function () {
        if (!userIdToDelete) {
            console.error('No user ID set for deletion');
            return;
        }

        const btn = this;
        btn.disabled = true;
        btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Deleting...`;

        console.log(`Attempting to delete user ID: ${userIdToDelete}`);

        fetch(`/api/delete-user/${userIdToDelete}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(res => {
                console.log('Delete response status:', res.status);
                console.log('Delete response headers:', res.headers);

                if (!res.ok) {
                    return res.text().then(text => {
                        console.error('Error response body:', text);
                        try {
                            const json = JSON.parse(text);
                            throw new Error(json.error || `Server error: ${res.status}`);
                        } catch (e) {
                            throw new Error(`Server error: ${res.status} - ${text}`);
                        }
                    });
                }

                return res.json();
            })
            .then(data => {
                console.log('Delete response data:', data);

                if (data.error) {
                    throw new Error(data.error);
                }

                if (data.success) {
                    console.log('Deletion successful, reloading page...');
                    deleteModal.hide();
                    setTimeout(() => location.reload(), 500);
                } else {
                    throw new Error('Unexpected response format');
                }
            })
            .catch(err => {
                console.error('Delete error:', err);
                alert(`Error deleting user: ${err.message}\n\nPlease check the browser console for more details.`);
                btn.disabled = false;
                btn.innerHTML = `Yes, Delete User`;
            });
    });
    });

    // Data Download Function 
    function downloadData(category, type) {
        const btn = event.currentTarget;
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Processing...`;

        const endpoint = type === 'csv' ? `/api/download-csv/${category}` : `/api/download-db/${category}`;

        fetch(endpoint)
            .then(res => {
                if (!res.ok) throw new Error('Download failed');
                return res.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `${category}_export_${new Date().getTime()}.${type === 'csv' ? 'csv' : 'db'}`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                btn.innerHTML = `<i class="fas fa-check"></i> Ready!`;
                setTimeout(() => { btn.disabled = false; btn.innerHTML = originalHtml; }, 2000);
            })
            .catch(err => {
                alert('Error: ' + err.message);
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            });
    }
</script>
{% endblock %}