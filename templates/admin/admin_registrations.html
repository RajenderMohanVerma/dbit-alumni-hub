{% extends "base.html" %}

{% block title %}Registration Management - Admin{% endblock %}

{% block content %}
<link
    href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">

<style>
    @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap');

    :root {
        --terminal-bg: #030712;
        --accent-primary: #6366f1;
        --accent-secondary: #a855f7;
        --accent-success: #10b981;
        --accent-warning: #f59e0b;
        --glass-bg: rgba(15, 23, 42, 0.7);
        --glass-border: rgba(255, 255, 255, 0.1);
        --text-dim: #94a3b8;
    }

    body {
        background: var(--terminal-bg);
        color: white;
        font-family: 'Outfit', sans-serif;
        overflow-x: hidden;
    }

    /* --- Background Layer --- */
    .premium-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at 50% 50%, #0f172a 0%, #020617 100%);
        z-index: -2;
    }

    .mesh-gradient {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        overflow: hidden;
        pointer-events: none;
    }

    .mesh-ball {
        position: absolute;
        width: 600px;
        height: 600px;
        border-radius: 50%;
        filter: blur(120px);
        opacity: 0.15;
        animation: floatOrb 20s infinite alternate;
    }

    @keyframes floatOrb {
        0% {
            transform: translate(0, 0) scale(1);
        }

        100% {
            transform: translate(100px, 50px) scale(1.1);
        }
    }

    /* --- Glass Components --- */
    .glass-card {
        background: var(--glass-bg);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid var(--glass-border);
        border-radius: 24px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
        padding: 30px;
        margin-bottom: 30px;
    }

    .reg-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 120px 2rem 4rem;
    }

    .matrix-title {
        font-size: 3.5rem;
        font-weight: 800;
        background: linear-gradient(to right, #fff, #94a3b8);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        letter-spacing: -1px;
        text-align: center;
        margin-bottom: 4rem;
    }

    /* --- Stats Matrix --- */
    .stats-matrix {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
    }

    .stat-orb {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--glass-border);
        border-radius: 20px;
        padding: 24px;
        transition: 0.3s;
    }

    .stat-orb:hover {
        background: rgba(255, 255, 255, 0.05);
        transform: translateY(-5px);
    }

    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        margin-bottom: 15px;
    }

    .orb-indigo {
        background: rgba(99, 102, 241, 0.1);
        color: #818cf8;
    }

    .orb-emerald {
        background: rgba(16, 185, 129, 0.1);
        color: #34d399;
    }

    .orb-amber {
        background: rgba(245, 158, 11, 0.1);
        color: #fbbf24;
    }

    .stat-count {
        font-family: 'JetBrains Mono', monospace;
        font-size: 2.2rem;
        font-weight: 700;
        color: white;
    }

    /* --- Filter Control --- */
    .filter-dock {
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
    }

    .dock-input {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--glass-border);
        border-radius: 14px;
        padding: 12px 20px;
        color: white;
        outline: none;
        transition: 0.3s;
    }

    .dock-input:focus {
        border-color: var(--accent-primary);
        background: rgba(255, 255, 255, 0.1);
    }

    /* --- Premium Table --- */
    .premium-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 10px;
    }

    .premium-table thead th {
        color: var(--text-dim);
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        padding: 1rem 1.5rem;
    }

    .premium-table tbody tr {
        background: rgba(255, 255, 255, 0.03);
        transition: 0.3s;
    }

    .premium-table tbody tr:hover {
        background: rgba(255, 255, 255, 0.07);
    }

    .premium-table tbody td {
        padding: 1.5rem;
        vertical-align: middle;
    }

    .role-pill {
        padding: 4px 12px;
        border-radius: 8px;
        font-size: 0.7rem;
        font-weight: 800;
        background: rgba(255, 255, 255, 0.1);
    }
</style>

<!-- Background Layer -->
<div class="premium-bg"></div>
<div class="mesh-gradient">
    <div class="mesh-ball" style="background: #4f46e5; top: -10%; left: -10%;"></div>
    <div class="mesh-ball" style="background: #7c3aed; bottom: -10%; right: -10%;"></div>
</div>

<div class="reg-container">
    <div class="matrix-header animate__animated animate__fadeInDown">
        <h1 class="matrix-title">Registration Ecosystem</h1>
        <p class="text-center text-dim fs-5 mb-5">Growth Telemetry • Cohort Management • Synchronization Matrix</p>
    </div>

    <!-- Stats Matrix -->
    <div class="stats-matrix">
        <div class="stat-orb animate__animated animate__zoomIn">
            <div class="stat-icon orb-indigo"><i class="fas fa-user-graduate"></i></div>
            <div class="stat-count">{{ stats.students }}</div>
            <div class="text-dim small fw-bold">STUDENT_SEGMENT</div>
        </div>
        <div class="stat-orb animate__animated animate__zoomIn" style="animation-delay: 0.1s;">
            <div class="stat-icon orb-emerald"><i class="fas fa-award"></i></div>
            <div class="stat-count">{{ stats.alumni }}</div>
            <div class="text-dim small fw-bold">LEGACY_NODES</div>
        </div>
        <div class="stat-orb animate__animated animate__zoomIn" style="animation-delay: 0.2s;">
            <div class="stat-icon orb-amber"><i class="fas fa-chalkboard-teacher"></i></div>
            <div class="stat-count">{{ stats.faculty }}</div>
            <div class="text-dim small fw-bold">MENTOR_NETWORK</div>
        </div>
        <div class="stat-orb animate__animated animate__zoomIn" style="animation-delay: 0.3s;">
            <div class="stat-icon orb-indigo"><i class="fas fa-globe"></i></div>
            <div class="stat-count">{{ stats.total }}</div>
            <div class="text-dim small fw-bold">AGGREGATE_MATRIX</div>
        </div>
    </div>

    <!-- Filter Dock -->
    <div class="glass-card mb-4 animate__animated animate__fadeInUp">
        <form method="GET" action="{{ url_for('admin_registrations') }}" class="filter-dock">
            <select name="role_filter" class="dock-input" onchange="this.form.submit()">
                <option value="">ALL_COHORTS</option>
                <option value="student" {% if current_filter=='student' %}selected{% endif %}>STUDENTS</option>
                <option value="alumni" {% if current_filter=='alumni' %}selected{% endif %}>ALUMNI</option>
                <option value="faculty" {% if current_filter=='faculty' %}selected{% endif %}>FACULTY</option>
            </select>
            <div class="flex-grow-1 position-relative">
                <i class="fas fa-search position-absolute top-50 translate-middle-y ms-3 text-primary"></i>
                <input type="text" name="search" class="dock-input ps-5 w-100"
                    placeholder="Scan node by name or hyper-reference..." value="{{ search_query or '' }}">
            </div>
            <button type="submit" class="btn btn-primary px-4 py-2 border-0"
                style="background: var(--accent-primary); border-radius: 12px;">
                <i class="fas fa-filter me-2"></i> APPLY_FILTER
            </button>
            <button type="button" onclick="exportData()" class="btn btn-outline-light px-4 py-2"
                style="border-radius: 12px;">
                <i class="fas fa-file-csv me-2"></i> MATRIX_EXPORT
            </button>
        </form>
    </div>

    <!-- Main Matrix -->
    <div class="glass-card animate__animated animate__fadeInUp" style="animation-delay: 0.1s;">
        {% if registrations %}
        <div class="table-responsive">
            <table class="premium-table">
                <thead>
                    <tr>
                        <th>Identifier</th>
                        <th>Identity</th>
                        <th>Classification</th>
                        <th>Sector/Department</th>
                        <th>Temporal Log</th>
                        <th>Access</th>
                    </tr>
                </thead>
                <tbody>
                    {% for reg in registrations %}
                    <tr>
                        <td><span class="text-dim fw-bold">#{{ reg.user_id }}</span></td>
                        <td>
                            <div class="d-flex flex-column">
                                <span class="fw-bold text-white">{{ reg.name }}</span>
                                <span class="text-dim small">{{ reg.email }}</span>
                            </div>
                        </td>
                        <td><span class="role-pill">{{ reg.role|upper }}</span></td>
                        <td>
                            <div class="d-flex flex-column">
                                <span class="fw-semibold text-white">{{ reg.department or 'GENERAL' }}</span>
                                <span class="text-dim small">{% if reg.role == 'student' %}{{ reg.enrollment_no }}{%
                                    else %}{{ reg.designation }}{% endif %}</span>
                            </div>
                        </td>
                        <td><span class="text-dim small"><i class="far fa-clock me-1"></i> {{ reg.registered_at
                                }}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary btn-view-details"
                                data-user-id="{{ reg.user_id }}" data-user-role="{{ reg.role }}"
                                style="border-radius: 8px;">
                                <i class="fas fa-fingerprint"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-radar fa-4x text-dim opacity-25 mb-4"></i>
            <h4 class="text-white fw-bold">No Entities Detected</h4>
            <p class="text-dim">The registration matrix is currently empty for the selected criteria.</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
    function exportData() {
        const btn = document.querySelector('button[onclick="exportData()"]');
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Orchestrating...';
        btn.disabled = true;
        setTimeout(() => {
            window.location.href = '/admin/export/registrations';
            setTimeout(() => {
                btn.innerHTML = '<i class="fas fa-file-csv me-2"></i> MATRIX_EXPORT';
                btn.disabled = false;
            }, 2000);
        }, 800);
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.btn-view-details').forEach(btn => {
            btn.addEventListener('click', () => {
                const userId = btn.getAttribute('data-user-id');
                const role = btn.getAttribute('data-user-role');
                let path = '';
                switch (role) {
                    case 'student': path = `/student/profile/${userId}`; break;
                    case 'alumni': path = `/alumni/profile/${userId}`; break;
                    case 'faculty': path = `/faculty/profile/${userId}`; break;
                    case 'admin': path = `/admin/profile/${userId}`; break;
                    default: path = `/profile/${userId}`;
                }
                window.location.href = path;
            });
        });
    });
</script>
{% endblock %}