{% extends "base.html" %}

{% block content %}
<link
    href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">

<style>
    :root {
        --primary-glass: rgba(255, 255, 255, 0.9);
        --accent-indigo: #6366f1;
        --accent-blue: #0ea5e9;
        --text-dark: #1e293b;
        --text-muted: #64748b;
    }

    .premium-admin-base {
        min-height: 100vh;
        background: radial-gradient(circle at top right, #f8fafc 0%, #f1f5f9 100%);
        padding: 100px 20px 40px;
        font-family: 'Plus Jakarta Sans', sans-serif;
    }

    .header-section {
        margin-bottom: 40px;
        animation: fadeInDown 0.8s ease;
    }

    .header-title {
        font-family: 'Outfit', sans-serif;
        font-weight: 800;
        font-size: 2.8rem;
        background: linear-gradient(135deg, #1e3a8a 0%, #6366f1 100%);
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 10px;
    }

    .glass-card {
        background: var(--primary-glass);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.5);
        border-radius: 28px;
        padding: 30px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.05);
        margin-bottom: 30px;
    }

    .role-navbar {
        display: flex;
        gap: 12px;
        background: #f1f5f9;
        padding: 6px;
        border-radius: 18px;
        width: fit-content;
        margin: 0 auto 40px;
    }

    .role-nav-link {
        padding: 10px 24px;
        border-radius: 14px;
        text-decoration: none;
        color: var(--text-muted);
        font-weight: 700;
        font-size: 0.95rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .role-nav-link.active {
        background: white;
        color: var(--accent-indigo);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.1);
        transform: scale(1.02);
    }

    .search-dock {
        display: flex;
        gap: 15px;
        margin-bottom: 30px;
    }

    .dock-input-wrapper {
        position: relative;
        flex: 1;
    }

    .dock-input {
        width: 100%;
        padding: 14px 20px 14px 50px;
        border-radius: 16px;
        border: 2px solid #f1f5f9;
        background: white;
        font-weight: 500;
        transition: all 0.3s;
    }

    .dock-input:focus {
        border-color: var(--accent-indigo);
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        outline: none;
    }

    .dock-icon {
        position: absolute;
        left: 20px;
        top: 50%;
        transform: translateY(-50%);
        color: #94a3b8;
    }

    .btn-premium {
        padding: 12px 24px;
        border-radius: 14px;
        font-weight: 700;
        transition: all 0.3s;
        border: none;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .btn-indigo {
        background: var(--accent-indigo);
        color: white;
    }

    .btn-white {
        background: white;
        border: 1px solid #e2e8f0;
        color: var(--text-dark);
    }

    .btn-indigo:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(99, 102, 241, 0.2);
    }

    .premium-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 12px;
    }

    .premium-table thead th {
        padding: 15px 25px;
        color: var(--text-muted);
        font-weight: 800;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 1px;
    }

    .user-row {
        background: white;
        transition: all 0.3s;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.02);
    }

    .user-row:hover {
        transform: scale(1.005);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.06);
    }

    .user-row td {
        padding: 20px 25px;
        vertical-align: middle;
    }

    .user-row td:first-child {
        border-top-left-radius: 20px;
        border-bottom-left-radius: 20px;
    }

    .user-row td:last-child {
        border-top-right-radius: 20px;
        border-bottom-right-radius: 20px;
    }

    .u-avatar {
        width: 50px;
        height: 50px;
        border-radius: 14px;
        object-fit: cover;
        border: 2px solid white;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .u-name {
        font-weight: 800;
        color: var(--text-dark);
        display: block;
    }

    .u-email {
        font-size: 0.85rem;
        color: var(--text-muted);
    }

    .role-pill {
        padding: 6px 14px;
        border-radius: 10px;
        font-size: 0.75rem;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .pill-student {
        background: #eff6ff;
        color: #1e40af;
    }

    .pill-alumni {
        background: #fff7ed;
        color: #9a3412;
    }

    .pill-faculty {
        background: #f0fdf4;
        color: #166534;
    }

    .pill-admin {
        background: #fef2f2;
        color: #991b1b;
    }

    .status-badge {
        font-size: 0.8rem;
        font-weight: 700;
        color: #10b981;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .status-pending {
        color: #f59e0b;
        background: rgba(245, 158, 11, 0.1);
        padding: 4px 10px;
        border-radius: 20px;
    }

    .status-verified {
        color: #10b981;
        background: rgba(16, 185, 129, 0.1);
        padding: 4px 10px;
        border-radius: 20px;
    }

    .row-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
    }

    .action-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f8fafc;
        color: var(--text-muted);
        transition: all 0.2s;
        border: 1px solid #f1f5f9;
    }

    .action-circle:hover {
        background: var(--accent-indigo);
        color: white;
        transform: scale(1.1);
        border-color: var(--accent-indigo);
    }

    .action-delete:hover {
        background: #ef4444;
        border-color: #ef4444;
    }

    @keyframes fadeInDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

<div class="premium-admin-base">
    <div class="container-fluid">
        <!-- Header -->
        <div class="header-section text-center">
            <h1 class="header-title">Member Directorate</h1>
            <p class="text-muted fw-medium">Governance and identity lifecycle management for the Alumni ecosystem</p>
        </div>

        <!-- Role Nav -->
        <div class="role-navbar animate__animated animate__fadeIn">
            <a href="{{ url_for('admin_view_users', role='all') }}"
                class="role-nav-link {% if role == 'all' %}active{% endif %}">
                <i class="fas fa-users-cog"></i> Collective
            </a>
            <a href="{{ url_for('admin_view_users', role='student') }}"
                class="role-nav-link {% if role == 'student' %}active{% endif %}">
                <i class="fas fa-user-graduate"></i> Students
            </a>
            <a href="{{ url_for('admin_view_users', role='alumni') }}"
                class="role-nav-link {% if role == 'alumni' %}active{% endif %}">
                <i class="fas fa-award"></i> Legacy
            </a>
            <a href="{{ url_for('admin_view_users', role='faculty') }}"
                class="role-nav-link {% if role == 'faculty' %}active{% endif %}">
                <i class="fas fa-chalkboard-teacher"></i> Mentors
            </a>
            <a href="{{ url_for('admin_approve_requests') }}"
                class="role-nav-link {% if role == 'pending' %}active{% endif %}">
                <i class="fas fa-clock"></i> Pending
            </a>
        </div>

        <!-- Search & Control -->
        <div class="search-dock animate__animated animate__fadeInUp">
            <div class="dock-input-wrapper">
                <i class="fas fa-fingerprint dock-icon"></i>
                <input type="text" id="userSearch" class="dock-input"
                    placeholder="Initiate member search by identity or department...">
            </div>
            <button class="btn-premium btn-white" onclick="location.reload()">
                <i class="fas fa-sync-alt"></i> Sync
            </button>
            <button class="btn-premium btn-indigo" onclick="window.print()">
                <i class="fas fa-file-signature"></i> Intelligence Export
            </button>
        </div>

        <!-- Directory -->
        <div class="glass-card animate__animated animate__fadeInUp" style="animation-delay: 0.1s;">
            {% if users %}
            <div class="table-responsive">
                <table class="premium-table" id="usersTable">
                    <thead>
                        <tr>
                            <th>Identity Matrix</th>
                            <th>Classification</th>
                            <th>Lifecycle Start</th>
                            <th>Operational Status</th>
                            <th class="text-end">Command</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr class="user-row">
                            <td>
                                <div class="d-flex align-items-center gap-3">
                                    <img src="https://ui-avatars.com/api/?name={{ user['name'] }}&background=6366f1&color=fff&rounded=true&bold=true"
                                        alt="" class="u-avatar">
                                    <div>
                                        <span class="u-name">{{ user['name'] }}</span>
                                        <span class="u-email">{{ user['email'] }}</span>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="role-pill pill-{{ user['role'] }}">
                                    {% if user['role'] == 'student' %}<i class="fas fa-user-graduate"></i> STUDENT
                                    {% elif user['role'] == 'alumni' %}<i class="fas fa-award"></i> ALUMNI
                                    {% elif user['role'] == 'faculty' %}<i class="fas fa-chalkboard-teacher"></i>
                                    FACULTY
                                    {% else %}<i class="fas fa-shield-alt"></i> ADMIN{% endif %}
                                </span>
                            </td>
                            <td>
                                <div class="text-muted fw-bold small">
                                    <i class="far fa-clock"></i> {{ user['created_at'][:10] }}
                                </div>
                            </td>
                            <td>
                                <span
                                    class="status-badge {% if user['is_approved'] == 0 %}status-pending{% else %}status-verified{% endif %}">
                                    {% if user['is_approved'] == 0 %}
                                    <i class="fas fa-clock"></i> PENDING
                                    {% else %}
                                    <i class="fas fa-check-circle"></i> VERIFIED
                                    {% endif %}
                                </span>
                            </td>
                            <td>
                                <div class="row-actions">
                                    {% if user['is_approved'] == 0 %}
                                    <a href="{{ url_for('verify_user', user_id=user['id'], action='approve') }}"
                                        class="action-circle btn-approve" title="Approve Access"
                                        style="color: #10b981; border-color: #10b981; background: #ecfdf5;">
                                        <i class="fas fa-check"></i>
                                    </a>
                                    {% endif %}
                                    Command
                                    <a href="{% if user['role'] == 'student' %}{{ url_for('student_profile', user_id=user['id']) }}{% elif user['role'] == 'alumni' %}{{ url_for('alumni_profile', user_id=user['id']) }}{% else %}{{ url_for('faculty_profile', user_id=user['id']) }}{% endif %}"
                                        class="action-circle" title="Inspect Identity">
                                        <i class="fas fa-fingerprint"></i>
                                    </a>
                                    {% if user['email'] != 'admindbit195@college.edu' %}
                                    <button class="action-circle action-delete" data-user-id="{{ user['id'] }}"
                                        data-user-name="{{ user['name'] }}" title="Redact Member">
                                        <i class="fas fa-user-slash"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-fingerprint fa-4x text-light-emphasis mb-3"></i>
                <h4 class="fw-bold">Static Matrix</h4>
                <p class="text-muted">No entities detected in the current classification segment.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>



<script>
    function confirmDelete(id, name) {
        if (confirm(`⚠ ADMIN WARNING ⚠\n\nAre you sure you want to PERMANENTLY delete user:\n\n${name}\n\nThis action cannot be undone.`)) {

            // Visual feedback
            const deleteBtn = document.querySelector(`.action-delete[data-user-id="${id}"]`);
            if (deleteBtn) {
                deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                deleteBtn.disabled = true;
            }

            fetch(`/api/delete-user/${id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert('✅ User deleted successfully.');
                        location.reload();
                    } else {
                        alert('❌ Error: ' + (data.error || 'Unknown error'));
                        if (deleteBtn) {
                            deleteBtn.innerHTML = '<i class="fas fa-user-slash"></i>';
                            deleteBtn.disabled = false;
                        }
                    }
                })
                .catch(err => {
                    alert('System Alert: ' + err.message);
                    if (deleteBtn) {
                        deleteBtn.innerHTML = '<i class="fas fa-user-slash"></i>';
                        deleteBtn.disabled = false;
                    }
                });
        }
    }

    document.getElementById('finalDeleteBtn')?.remove(); // Cleanup if exists

    document.getElementById('userSearch').addEventListener('input', function (e) {
        const searchTerm = e.target.value.toLowerCase();
        document.querySelectorAll('.user-row').forEach(row => {
            row.style.display = row.innerText.toLowerCase().includes(searchTerm) ? '' : 'none';
        });
    });

    // Add event listeners to delete buttons
    document.querySelectorAll('.action-delete').forEach(btn => {
        btn.addEventListener('click', function () {
            const userId = this.getAttribute('data-user-id');
            const userName = this.getAttribute('data-user-name');
            confirmDelete(userId, userName);
        });
    });


</script>
{% endblock %}