{% extends "base.html" %}

{% block title %}Community Messenger - Alumni Hub Signal Feed{% endblock %}

{% block content %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap');

    :root {
        --terminal-bg: #030712;
        --accent-primary: #6366f1;
        --accent-secondary: #a855f7;
        --accent-emerald: #10b981;
        --accent-amber: #f59e0b;
        --accent-rose: #ef4444;
        --glass-bg: rgba(15, 23, 42, 0.7);
        --glass-border: rgba(255, 255, 255, 0.1);
        --text-dim: #94a3b8;
    }

    body {
        background: var(--terminal-bg);
        color: white;
        font-family: 'Outfit', sans-serif;
        overflow-x: hidden;
    }

    /* --- Background Layer --- */
    .premium-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at 50% 50%, #0f172a 0%, #020617 100%);
        z-index: -2;
    }

    .mesh-gradient {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        overflow: hidden;
        pointer-events: none;
    }

    .mesh-ball {
        position: absolute;
        width: 600px;
        height: 600px;
        border-radius: 50%;
        filter: blur(120px);
        opacity: 0.1;
        animation: floatOrb 20s infinite alternate;
    }

    @keyframes floatOrb {
        0% {
            transform: translate(0, 0) scale(1);
        }

        100% {
            transform: translate(100px, 50px) scale(1.1);
        }
    }

    /* --- Page Layout --- */
    .messaging-wrapper {
        max-width: 1400px;
        margin: 0 auto;
        padding: 120px 2rem 4rem;
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 2rem;
    }

    .matrix-title {
        grid-column: 1 / -1;
        font-size: 3.5rem;
        font-weight: 800;
        background: linear-gradient(to right, #fff, #94a3b8);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        letter-spacing: -1px;
        text-align: center;
        margin-bottom: 3rem;
    }

    /* --- Components --- */
    .glass-card {
        background: var(--glass-bg);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid var(--glass-border);
        border-radius: 24px;
        padding: 30px;
        height: fit-content;
    }

    .section-header {
        font-size: 0.8rem;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 2px;
        color: var(--accent-primary);
        margin-bottom: 25px;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .section-header::after {
        content: '';
        flex: 1;
        height: 1px;
        background: linear-gradient(to right, var(--glass-border), transparent);
    }

    /* --- Message Feed --- */
    .feed-container {
        max-height: 600px;
        overflow-y: auto;
        padding-right: 15px;
    }

    .feed-container::-webkit-scrollbar {
        width: 5px;
    }

    .feed-container::-webkit-scrollbar-thumb {
        background: var(--glass-border);
        border-radius: 10px;
    }

    .message-item {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--glass-border);
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 1.5rem;
        transition: 0.3s;
    }

    .message-item:hover {
        background: rgba(255, 255, 255, 0.05);
        border-color: var(--accent-primary);
    }

    .sender-avatar {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        font-size: 0.8rem;
    }

    .sender-name {
        font-weight: 700;
        color: white;
        margin-right: 10px;
    }

    .sender-tag {
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.65rem;
        background: rgba(255, 255, 255, 0.05);
        padding: 3px 8px;
        border-radius: 4px;
        color: var(--text-dim);
    }

    .message-content {
        color: #cbd5e1;
        line-height: 1.6;
        margin: 15px 0;
        font-size: 0.95rem;
    }

    /* --- Input Area --- */
    .input-dock {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid var(--glass-border);
        border-radius: 16px;
        padding: 10px;
        display: flex;
        gap: 10px;
        margin-bottom: 30px;
    }

    .terminal-input {
        background: transparent;
        border: none;
        color: white;
        padding: 12px 15px;
        flex: 1;
        font-family: 'JetBrains Mono', monospace;
    }

    .terminal-input:focus {
        outline: none;
    }

    .btn-transmit {
        background: var(--accent-primary);
        color: white;
        border: none;
        padding: 0 25px;
        border-radius: 12px;
        font-weight: 800;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 1px;
        transition: 0.3s;
    }

    .btn-transmit:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(99, 102, 241, 0.4);
    }

    /* --- Inbox --- */
    .inbox-item {
        padding: 15px;
        border-radius: 14px;
        border: 1px solid transparent;
        transition: 0.3s;
        cursor: pointer;
        margin-bottom: 10px;
    }

    .inbox-item:hover {
        background: rgba(255, 255, 255, 0.05);
        border-color: var(--glass-border);
    }

    .inbox-item.active {
        background: rgba(99, 102, 241, 0.1);
        border-color: var(--accent-primary);
    }

    .unread-dot {
        width: 8px;
        height: 8px;
        background: var(--accent-rose);
        border-radius: 50%;
        display: inline-block;
        box-shadow: 0 0 10px var(--accent-rose);
    }

    /* --- Lock Status --- */
    .system-alert {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        border-radius: 12px;
        padding: 15px;
        color: var(--accent-rose);
        font-weight: 700;
        font-size: 0.85rem;
        margin-bottom: 20px;
        display: none;
    }

    .system-alert.visible {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    @keyframes pulse {
        0% {
            opacity: 1;
        }

        50% {
            opacity: 0.5;
        }

        100% {
            opacity: 1;
        }
    }

    .live-pulse {
        color: var(--accent-emerald);
        animation: pulse 2s infinite;
    }
</style>

<!-- Background Layer -->
<div class="premium-bg"></div>
<div class="mesh-gradient">
    <div class="mesh-ball" style="background: #6366f1; top: -10%; left: -10%;"></div>
    <div class="mesh-ball" style="background: #10b981; bottom: -10%; right: -10%;"></div>
</div>

<div class="messaging-wrapper">
    <h1 class="matrix-title">Encryption Feed</h1>

    <!-- Public Feed Section -->
    <div class="glass-card animate__animated animate__fadeInLeft">
        <div class="section-header">
            <i class="fas fa-broadcast-tower live-pulse"></i> GLOBAL_BROADCAST_LAYER
        </div>

        <div class="system-alert" id="lockStatus">
            <i class="fas fa-shield-alt"></i> SYSTEM_LOCKED: READ_ONLY_PROTOCOL_ACTIVE
        </div>

        <div class="input-dock">
            <input type="text" id="messageInput" class="terminal-input" placeholder="ACCESS_COMMUNICATION_LINE..."
                maxlength="5000">
            <button class="btn-transmit" id="sendBtn">TRANSMIT</button>
        </div>

        <div class="feed-container" id="messagesFeed">
            <div class="text-center py-5 text-dim">
                <i class="fas fa-satellite-dish fa-3x mb-3"></i>
                <p class="font-monospace">SCANNING_FOR_INCOMING_SIGNALS...</p>
            </div>
        </div>

        <!-- Typing -->
        <div id="typingIndicator" style="display: none;" class="mt-3 font-monospace small text-dim">
            <span id="typingUser" class="text-primary fw-bold"></span> IS_ENCRYPTING_DATA...
        </div>
    </div>

    <!-- Inbox Matrix -->
    <div class="glass-card animate__animated animate__fadeInRight">
        <div class="section-header">
            <i class="fas fa-inbox"></i> SESSION_MATRIX
        </div>

        <div id="inboxContainer">
            <div class="text-center py-5 text-dim">
                <p class="font-monospace">NO_ACTIVE_SESSIONS</p>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
    const socket = io();
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const messagesFeed = document.getElementById('messagesFeed');
    const lockStatus = document.getElementById('lockStatus');
    const typingIndicator = document.getElementById('typingIndicator');
    const typingUser = document.getElementById('typingUser');

    let typingTimeout;
    let isTyping = false;
    let systemLocked = false;

    socket.on('connect', () => {
        refreshLockStatus();
        loadPublicMessages();
        loadInbox();
    });

    socket.on('receive_public_message', (data) => addMessageToFeed(data));

    socket.on('system_locked', (data) => {
        systemLocked = true;
        lockStatus.classList.add('visible');
        messageInput.disabled = true;
        sendBtn.disabled = true;
        lockStatus.innerHTML = `<i class="fas fa-shield-alt"></i> LOCKED_BY_${data.locked_by.toUpperCase()}: ${data.reason || 'SYSTEM_HALT'}`;
    });

    socket.on('system_unlocked', () => {
        systemLocked = false;
        lockStatus.classList.remove('visible');
        messageInput.disabled = false;
        sendBtn.disabled = false;
    });

    socket.on('user_typing_public', (data) => {
        typingUser.textContent = data.user_name.toUpperCase();
        typingIndicator.style.display = 'block';
    });

    socket.on('user_stopped_typing_public', () => {
        typingIndicator.style.display = 'none';
    });

    socket.on('message_deleted_public', (data) => {
        const el = document.querySelector(`[data-message-id="${data.message_id}"]`);
        if (el) el.remove();
    });

    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });

    function sendMessage() {
        const content = messageInput.value.trim();
        if (!content) return;
        socket.emit('send_public_message', { content });
        messageInput.value = '';
        socket.emit('stop_typing_public');
        isTyping = false;
    }

    messageInput.addEventListener('input', () => {
        if (!isTyping && !systemLocked) {
            isTyping = true;
            socket.emit('typing_public');
        }
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            isTyping = false;
            socket.emit('stop_typing_public');
        }, 3000);
    });

    function addMessageToFeed(message) {
        if (messagesFeed.querySelector('.text-center')) messagesFeed.innerHTML = '';

        const initials = message.sender_name.substring(0, 2).toUpperCase();
        const item = document.createElement('div');
        item.className = 'message-item animate__animated animate__fadeInUp';
        item.setAttribute('data-message-id', message.id);

        item.innerHTML = `
            <div class="d-flex align-items-center gap-3">
                <div class="sender-avatar">${initials}</div>
                <div class="flex-grow-1">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="sender-name">${message.sender_name}</span>
                            <span class="sender-tag">${message.sender_role.toUpperCase()}</span>
                        </div>
                        <span class="font-monospace small text-dim">${new Date(message.created_at).toLocaleTimeString()}</span>
                    </div>
                </div>
            </div>
            <div class="message-content">${escapeHtml(message.content)}</div>
            <div class="d-flex gap-2">
                <a href="https://wa.me/${message.sender_phone || ''}" target="_blank" class="btn-transmit" style="padding: 5px 12px; font-size: 0.6rem; text-decoration: none; background: #25d366;">
                    WHATSAPP_LINK
                </a>
            </div>
        `;
        messagesFeed.prepend(item);
    }

    function loadPublicMessages() {
        fetch('/api/messages/public?limit=50&offset=0')
            .then(r => r.json())
            .then(data => {
                if (data.messages && data.messages.length > 0) {
                    messagesFeed.innerHTML = '';
                    data.messages.reverse().forEach(msg => addMessageToFeed(msg));
                }
            });
    }

    function loadInbox() {
        fetch('/api/messages/inbox')
            .then(r => r.json())
            .then(data => {
                if (data.conversations && data.conversations.length > 0) updateInbox(data.conversations);
            });
    }

    function updateInbox(convs) {
        const container = document.getElementById('inboxContainer');
        container.innerHTML = '';
        convs.forEach(c => {
            const el = document.createElement('div');
            el.className = 'inbox-item';
            el.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <span class="fw-bold text-white">${c.other_user_name}</span>
                    ${c.unread_count > 0 ? '<span class="unread-dot"></span>' : ''}
                </div>
                <div class="font-monospace small text-dim text-truncate">${c.last_message_content || 'NO_DATA'}</div>
            `;
            el.onclick = () => window.location.href = `/chat/${c.other_user_id}`;
            container.appendChild(el);
        });
    }

    function refreshLockStatus() {
        fetch('/api/admin/messaging/status')
            .then(r => r.json())
            .then(data => {
                if (data.is_locked) {
                    systemLocked = true;
                    messageInput.disabled = true;
                    sendBtn.disabled = true;
                    lockStatus.classList.add('visible');
                    lockStatus.innerHTML = `<i class="fas fa-shield-alt"></i> SYSTEM_LOCKED: ${data.reason.toUpperCase() || 'READ_ONLY'}`;
                }
            }).catch(() => { });
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    setInterval(loadInbox, 10000);
</script>

{% endblock %}